---
title: "Google Analytics Customer: Preprocess"
author: "kotsubo takuto"
output: 
    html_document:
      md_extensions: -ascii_identifiers
      toc: true
      toc_depth: 3
      code_folding: hide
---

# Setting{.tabset .tabset-fade .tabset-pills}

## knitr option

```{r reset, include=FALSE}
# 初期化
rm(list = ls())
```

```{r set up, message=FALSE}
# set directory
setwd("~/Desktop/Google_Analytics_Kaggle/") 
# max.print 
options(max.print="200", digits=5)
# Global options
library(knitr)
opts_chunk$set(echo=TRUE,
               cache = FALSE,
	             prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

## Library package

```{r package, message=FALSE}
library(tidyverse)
library(readr) # for csv
library(summarytools) # summary easily for EDA
library(GGally) # ggpairs
library(skimr) 
library(janitor)
library(jsonlite)
```

## Load funciton

```{r}
source('~/Desktop/Google_Analytics_Kaggle/script/function.R') # for preprocessing
source('~/Desktop/Google_Analytics_Kaggle/script/makedummies.R') # for preprocessing
```

## Import csv

- Import raw data from `input/raw/{tarin|test}.csv`
- `device`, `geoNetwork`, `totals` and `trafficSource` are JSON style columns.

```{r cache=TRUE}
# read sample data
train_sample <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/raw/train.csv",na = c("XNA","NA","","NaN","?"), n_max = 1000)
# extract columns class
col_vars_candidate <- train_sample %>% 
  map_chr(class)
col_vars <-  
      case_when(col_vars_candidate == "character" ~ "c",
                col_vars_candidate == "integer" ~ "i",
                col_vars_candidate == "numeric" ~ "d") %>% 
      purrr::set_names(names(col_vars_candidate)) %>% # set name by columns class
      as.list() %>% # list
      list_modify(date = "D", visitId = "c") %>% 
      flatten_chr() %>% # unlist
      str_c(collapse = "") # connect
# read raw data
train_raw <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/raw/train.csv",
                      na = c("XNA","NA","","NaN","?"),
                      col_types = col_vars,
                      locale = readr::locale(date_format = "%Y%m%d"))
test_raw <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/raw/test.csv",
                      na = c("XNA","NA","","NaN","?"),
                      col_types = col_vars,
                      locale = readr::locale(date_format = "%Y%m%d"))
# json columns
json_vars = c("device", "geoNetwork", "totals", "trafficSource")
# make a flatten data set
train_flat <- ReadJsonFile(train_raw, json_vars = json_vars)
test_flat <- ReadJsonFile(test_raw, json_vars = json_vars)
```

# Preprocess

- Remove columns for which information can not be obtained
- change character type and logical type to numeric type
- Replace NA with zero on target values
- How to deal with `visitStartTime` : not yet

## Remove columns for which information can not be obtained

- "not available in demo datase", "not set" and NA value are same?? 

```{r}
train_flat <-
  train_flat %>% 
  select(-c(socialEngagementType,browserSize,browserVersion,operatingSystemVersion,
            mobileDeviceBranding,mobileDeviceModel,mobileDeviceMarketingName,mobileDeviceInfo,
            mobileInputSelector,flashVersion,language,screenColors,screenResolution,
            cityId,latitude,longitude,networkLocation,visits,campaignCode,adwordsClickInfo.criteriaParameters))
test_flat <-
  test_flat %>% 
  select(-c(socialEngagementType,browserSize,browserVersion,operatingSystemVersion,
            mobileDeviceBranding,mobileDeviceModel,mobileDeviceMarketingName,mobileDeviceInfo,
            mobileInputSelector,flashVersion,language,screenColors,screenResolution,
            cityId,latitude,longitude,networkLocation,visits,adwordsClickInfo.criteriaParameters))
```

## change character type and logical type to numeric type

- 3つのIDはcharcter型で良いか? -> 分析時はこれらの項目は消すので問題ない?

```{r}
train_flat <-
  train_flat %>% 
  mutate_at(c("isMobile", "isTrueDirect","adwordsClickInfo.isVideoAd"), funs(as.numeric(.))) %>% 
  mutate_at(c("hits","pageviews","bounces","newVisits","transactionRevenue","adwordsClickInfo.page"), funs(as.numeric(.))) -> tmp
test_flat <-
  test_flat %>% 
  mutate_at(c("isMobile", "isTrueDirect","adwordsClickInfo.isVideoAd"), funs(as.numeric(.))) %>% 
  mutate_at(c("hits","pageviews","bounces","newVisits","adwordsClickInfo.page"), funs(as.numeric(.)))
```

## Replace NA with zero on target values

```{r}
train_flat <- 
  train_flat %>% 
  mutate(transactionRevenue = ifelse(is.na(transactionRevenue),0,transactionRevenue)) 
```

## How to deal with `visitStartTime` 

- `date` not need

```{r}
train_flat <- train_flat %>% 
  mutate(visitStartTime = as.POSIXct(visitStartTime, origin='1970-01-01', tz = "US/Pacific")) %>% 
  select(-date)
test_flat <- test_flat %>% 
  mutate(visitStartTime = as.POSIXct(visitStartTime, origin='1970-01-01', tz = "US/Pacific")) %>% 
  select(-date)
```

# Export

- 2018/ 9 /18
- simple imputation data

```{r}
write_csv(train_flat,"~/Desktop/Google_Analytics_Kaggle/input/imp/train_imp1.scv")
write_csv(test_flat,"~/Desktop/Google_Analytics_Kaggle/input/imp/test_imp1.scv")
```

