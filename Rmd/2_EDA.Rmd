---
title: "Google Analytics Customer: EDA"
author: "kotsubo takuto"
output: 
    html_document:
      md_extensions: -ascii_identifiers
      toc: true
      toc_depth: 3
      code_folding: hide
---

# Setting{.tabset .tabset-fade .tabset-pills}

## knitr option

```{r reset, include=FALSE}
# 初期化
rm(list = ls())
```

```{r set up, message=FALSE}
# set directory
setwd("~/Desktop/Google_Analytics_Kaggle/") 
# max.print 
options(max.print="200", digits=5)
# show option  
options("scipen"=100, "digits"=4)
# time zone option
options(readr.default_locale=readr::locale(tz="US/Pacific"))

# Global options
library(knitr)
opts_chunk$set(echo=TRUE,
               cache = FALSE,
	             prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

## Library package

```{r package, message=FALSE}
library(tidyverse)
library(readr) # for csv
library(summarytools) # summary easily for EDA
library(GGally) # ggpairs
library(skimr) 
library(janitor)
library(jsonlite)
library(lubridate)
library(pipeR)
```

## Load funciton

```{r}
source('~/Desktop/Google_Analytics_Kaggle/script/function.R') # for preprocessing
source('~/Desktop/Google_Analytics_Kaggle/script/makedummies.R') # for preprocessing
```

## Import csv

- Import raw data from `input/imp/{tarin|test}.csv`

```{r cache=TRUE}
# read impute data
train_imp <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/imp/train_imp1.csv")
test_imp <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/imp/test_imp1.csv")
```

# Explatory Data Analysis

- Apply glimpse and dfsummary to the all data
- Check three id values
- Confirm relationship with target variables: not yet 

## Apply glimpse and dfsummary to the all data{.tabset .tabset-fade .tabset-pills}

### glimpse 

```{r cache=TRUE}
glimpse(train_imp)
glimpse(test_imp)
```

### dfsummary

```{r cache=TRUE}
dfSummary(train_imp) %>% 
  view(method = "render")
dfSummary(test_imp) %>% 
  view(method = "render")
```

## Check three id values

それぞれのidが何を意味しているのか, 集約する上で理解する必要がある. 前処理したデータに対して, あらためて調査する.

- `fullVisitorId`
- `visitId`

### check what mean values

各idにおいて同値のidが何を意味するのか調べる. 

- `fullVisitorId`:
    - user idと考えて良さそう, 個人情報が同じ. 
    - 各user の`newVisits`が複数回ある場合がある (2: 2834, 3:30). 
    - 各userの`visitNumber`にも同じ値が出現していることある (2:4052, 3: 42).
    - 解決策: 観測期間でid振り直して, id == 1 & visitNumber == 1の行を newVisits =1とする?  

```{r}
train_imp %>% 
  group_by(fullVisitorId) %>% 
  mutate(num = row_number()) %>% 
  filter(num == max(num)) %>% 
  ungroup() %>% 
  select(fullVisitorId,num) -> tmp

tmp %>% 
  inner_join(train_imp,by=c("fullVisitorId")) -> tmp1

train_imp %>% 
  filter(newVisits == 1) %>% 
  group_by(fullVisitorId) %>% 
  mutate(num1 = n()) %>% 
  tabyl(num1)

train_imp %>% 
  group_by(fullVisitorId, visitNumber) %>% 
  mutate(num = n()) %>% 
  ungroup() %>% 
  tabyl(num)
```

- `visitId`:
    - システム側の id, visitStartTimeが同じであることから推測
    - `visitId`と`visitStartTime`のuniqueな個数が一致しない (dif 856個) -> user 側の time zone 使われている??
    - dateと比べて情報ないので不要??

```{r}
train_imp %>% 
  group_by(visitId) %>% 
  mutate(num = row_number()) %>% 
  filter(num == max(num)) %>% 
  ungroup() %>% 
  select(visitId,num) -> tmp

tmp %>% 
  inner_join(train_imp,by=c("visitId")) -> tmp2

train_imp %>>%
  (~ distinct(.,visitId) %>% NROW %>% print) %>% 
  distinct(visitStartTime) %>% NROW
```

- `fullVisitorId` & `visitId` : 

```{r}
train_imp %>% 
  group_by(fullVisitorId, visitId) %>% 
  mutate(num = row_number()) %>% 
  filter(num == max(num)) %>% 
  ungroup() %>% 
  select(fullVisitorId,visitId,num) -> tmp

tmp %>% 
  inner_join(train_imp,by=c("fullVisitorId","visitId")) -> tmp3
```





