---
title: "Google Analytics Customer: EDA"
author: "kotsubo takuto"
output: 
    html_document:
      md_extensions: -ascii_identifiers
      toc: true
      toc_depth: 3
      code_folding: hide
---

# Setting{.tabset .tabset-fade .tabset-pills}

## knitr option

```{r reset, include=FALSE}
# 初期化
rm(list = ls())
```

```{r set up, message=FALSE}
# set directory
setwd("~/Desktop/Google_Analytics_Kaggle/") 
# max.print 
options(max.print="200", digits=5)
# Global options
library(knitr)
opts_chunk$set(echo=TRUE,
               cache = FALSE,
	             prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

## Library package

```{r package, message=FALSE}
library(tidyverse)
library(readr) # for csv
library(summarytools) # summary easily for EDA
library(GGally) # ggpairs
library(skimr) 
library(janitor)
library(jsonlite)
```

## Load funciton

```{r}
source('~/Desktop/Google_Analytics_Kaggle/script/function.R') # for preprocessing
source('~/Desktop/Google_Analytics_Kaggle/script/makedummies.R') # for preprocessing
```

## Import csv

- Import raw data from `input/raw/{tarin|test}.csv`
- `device`, `geoNetwork`, `totals` and `trafficSource` are JSON style columns.

```{r cache=TRUE}
# read sample data
train_sample <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/raw/train.csv",na = c("XNA","NA","","NaN","?"), n_max = 1000)
# extract columns class
col_vars_candidate <- train_sample %>% 
  map_chr(class)
col_vars <-  
      case_when(col_vars_candidate == "character" ~ "c",
                col_vars_candidate == "integer" ~ "i",
                col_vars_candidate == "numeric" ~ "d") %>% 
      purrr::set_names(names(col_vars_candidate)) %>% # set name by columns class
      as.list() %>% # list
      list_modify(date = "D", visitId = "c") %>% 
      flatten_chr() %>% # unlist
      str_c(collapse = "") # connect
# read raw data
train_raw <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/raw/train.csv",
                      na = c("XNA","NA","","NaN","?"),
                      col_types = col_vars,
                      locale = readr::locale(date_format = "%Y%m%d"))
test_raw <- read_csv("~/Desktop/Google_Analytics_Kaggle/input/raw/test.csv",
                      na = c("XNA","NA","","NaN","?"),
                      col_types = col_vars,
                      locale = readr::locale(date_format = "%Y%m%d"))
# json columns
json_vars = c("device", "geoNetwork", "totals", "trafficSource")
# make a flatten data set
train_flat <- ReadJsonFile(train_raw, json_vars = json_vars)
test_flat <- ReadJsonFile(test_raw, json_vars = json_vars)
```

## Extract col names

- not execute

```{r eval=FALSE}
tmp <- (sapply(train_flat, class) %>% data.frame(train = .))
tmp <- (sapply(test_flat, class) %>% data.frame(test = .)) 

write.csv2(tmp,"~/Desktop/Google_Analytics_Kaggle/data/new_column_names.csv",row.names=TRUE)
# tmp %>% filter(str_detect(new,"id"))
```

# Explatory Data Analysis

- Apply glimpse, skimr and dfsummary to the all data
- Search target values
- Check unique values
- Confirm relationship with target variables

## Apply glimpse, skimr and dfsummary to the all data{.tabset .tabset-fade .tabset-pills}

### glimpse 

```{r cache=TRUE}
glimpse(train_flat)
glimpse(test_flat)
```

### skimr

```{r cache=TRUE}
skimr::skim_to_wide(train_flat) %>% kable()
skimr::skim_to_wide(test_flat) %>% kable()
```

### dfsummary

```{r cache=TRUE}
dfSummary(train_flat) %>% 
  view(method = "render")
dfSummary(test_flat) %>% 
  view(method = "render")
```

## Search target values

- target: `transactionRevenue`
- `campaignCode` is nothing in test data

```{r}
tmp <- train_flat %>% 
  colnames() %>%
  data.frame(col = .,train = 1) %>% 
  full_join(test_flat %>% 
              colnames() %>% 
              data.frame(col = ., test = 1),
            by = "col")
```

## Check unique values

```{r}
train_raw %>% 
  distinct(fullVisitorId, .keep_all = FALSE) %>% 
  NROW
test_raw %>% 
  distinct(fullVisitorId) %>% 
  NROW
train_raw %>% 
  distinct(sessionId, .keep_all = FALSE) %>% 
  NROW

train_raw %>% 
  tabyl(sessionId) %>% 
  arrange(desc(n))
```
